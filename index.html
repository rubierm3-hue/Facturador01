<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>D&R Designs - Facturador V16</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e293b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        #offscreen-render-area { position: absolute; left: -9999px; top: 0; width: 500px; }
        .invoice-card { background-color: white; background-image: radial-gradient(#f1f5f9 1px, transparent 1px); background-size: 20px 20px; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden bg-slate-50">

    <!-- Barra Superior -->
    <nav class="bg-slate-900 text-white shadow-lg z-30 flex-shrink-0 pt-safe-top">
        <div class="max-w-5xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer" onclick="ui.navigate('dashboard')">
                <div class="w-9 h-9 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold shadow-lg border border-slate-700">
                    <i class="fas fa-paint-brush text-xs"></i>
                </div>
                <span class="font-bold text-lg tracking-wide">D&R Designs</span>
            </div>
            <div class="flex gap-4 hidden" id="nav-actions">
                <button onclick="ui.navigate('dashboard')" class="text-slate-400 hover:text-white transition"><i class="fas fa-history text-lg"></i></button>
                <button onclick="ui.navigate('editor')" class="bg-indigo-600 hover:bg-indigo-500 text-white w-8 h-8 rounded-full font-bold transition shadow-md flex items-center justify-center"><i class="fas fa-plus text-sm"></i></button>
                <button onclick="appActions.logout()" class="text-red-400 hover:text-red-300 transition ml-1"><i class="fas fa-power-off text-lg"></i></button>
            </div>
        </div>
    </nav>

    <!-- Contenido Principal -->
    <main id="main-content" class="flex-grow overflow-y-auto p-4 relative pb-20">
        <div class="h-full flex items-center justify-center text-slate-400 animate-pulse">
            <i class="fas fa-circle-notch fa-spin mr-2"></i> Conectando...
        </div>
    </main>

    <!-- Modal Previsualización -->
    <div id="preview-modal" class="fixed inset-0 z-50 hidden bg-slate-900/95 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm flex flex-col overflow-hidden max-h-[95vh]">
            <div class="p-3 bg-slate-50 border-b border-slate-200 flex justify-between items-center flex-shrink-0">
                <h3 class="font-bold text-slate-700 text-sm flex items-center"><i class="fas fa-eye mr-2 text-indigo-600"></i> Vista Previa</h3>
                <button onclick="ui.closeModal()" class="w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center text-slate-500 transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto p-4 bg-slate-200 flex justify-center">
                <div id="screen-preview-container" class="w-full shadow-xl transition-transform origin-top bg-white"></div>
            </div>
            <div class="p-4 border-t border-slate-100 bg-white grid grid-cols-2 gap-3 flex-shrink-0">
                <button id="btn-download" onclick="logic.downloadImage()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow transition text-sm flex items-center justify-center gap-2 active:scale-95"><i class="fas fa-download"></i> Descargar</button>
                <button id="btn-save" onclick="logic.saveAndClose()" class="bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-xl shadow transition text-sm active:scale-95">Finalizar</button>
            </div>
        </div>
    </div>

    <div id="offscreen-render-area"></div>

    <!-- LÓGICA -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, updateDoc, deleteDoc, getDocs, query, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const COMPANY = { name: "D&R DESIGNS", slogan: "LA CREATIVIDAD NO TIENE LÍMITES", bank: "Cuenta de Ahorros Bancolombia", account: "91253141293" };
        const PRODUCTS = [
            { name: "Mug Estándar", price: 18000 }, { name: "Mug Mágico", price: 25000 }, { name: "Gorra Personalizada", price: 25000 },
            { name: "Diseño Gráfico (Invitación)", price: 30000 }, { name: "Lámina de Aluminio (Sin Marco)", price: 30000 }, { name: "Botella de Aluminio", price: 30000 },
            { name: "Camiseta Sublimada", price: 30000 }, { name: "Camiseta DTF (Algodón)", price: 45000 }, { name: "Termo Acero Inox. 500ml", price: 50000 },
            { name: "Cuadro en Aluminio (Con Marco)", price: 55000 }, { name: "Cojín DTF (Área Grande)", price: 65000 }, { name: "Camiseta DTF (Premium)", price: 75000 },
            { name: "Buzo Estampado DTF", price: 100000 }
        ];

        // --- TUS CÓDIGOS DE FIREBASE (Incluidos) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDiNRn-HxaP9bdsHxmYISOJa3X0eFsDY7g",
            authDomain: "facturadordr.firebaseapp.com",
            projectId: "facturadordr",
            storageBucket: "facturadordr.firebasestorage.app",
            messagingSenderId: "195211543172",
            appId: "1:195211543172:web:80685cf5dfb6a15f5cf8d1"
        };
        const appId = 'dr-designs-app';

        let db, auth;
        try {
            const fbApp = initializeApp(firebaseConfig);
            auth = getAuth(fbApp);
            db = getFirestore(fbApp);
        } catch (e) { console.warn("Error Firebase", e); }

        const state = { user: null, invoices: [], cart: [], clientName: "", logoUrl: localStorage.getItem('dr_logo_v5') || null, nextInvoiceNumber: 1, viewingInvoice: null };

        const ui = {
            money: (val) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }).format(val),
            navigate: (view) => {
                const main = document.getElementById('main-content');
                if (view === 'login') ui.renderLogin(main);
                else if (view === 'dashboard') ui.renderDashboard(main);
                else if (view === 'editor') ui.renderEditor(main);
            },
            renderLogin: (container) => {
                document.getElementById('nav-actions').classList.add('hidden');
                container.innerHTML = `<div class="h-full flex items-center justify-center fade-in"><div class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm text-center border border-slate-100"><div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600 text-3xl"><i class="fas fa-fingerprint"></i></div><h1 class="text-2xl font-black text-slate-800 mb-1">Acceso Interno</h1><p class="text-slate-500 text-sm mb-8">D&R Designs Facturación</p><button id="login-btn" onclick="appActions.login()" class="w-full bg-slate-900 text-white font-bold py-4 rounded-xl hover:bg-slate-800 transition shadow-lg active:scale-95">INGRESAR</button></div></div>`;
            },
            renderDashboard: (container) => {
                const total = state.invoices.reduce((acc, curr) => acc + (curr.total || 0), 0);
                const list = state.invoices.length ? state.invoices.map(inv => `
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 mb-3 flex justify-between items-center hover:shadow-md transition">
                        <div><div class="flex items-center gap-2"><span class="bg-indigo-50 text-indigo-700 text-[10px] font-bold px-2 py-0.5 rounded border border-indigo-100">#${String(inv.number || '---').padStart(3, '0')}</span><span class="font-bold text-slate-800 text-sm">${inv.client}</span></div><p class="text-[10px] text-slate-400 mt-1">${new Date(inv.date?.seconds * 1000).toLocaleDateString()} • ${inv.items.length} items</p></div>
                        <div class="text-right"><p class="font-black text-slate-800 text-sm">${ui.money(inv.total)}</p><div class="flex gap-3 justify-end mt-1"><button onclick="logic.viewInvoice('${inv.id}')" class="text-indigo-500 hover:text-indigo-700"><i class="fas fa-eye"></i></button><button onclick="logic.deleteInvoice('${inv.id}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></div></div>
                    </div>`).join('') : '<div class="text-center py-10 text-slate-400"><i class="fas fa-folder-open text-4xl mb-2 opacity-30"></i><p>Sin ventas</p></div>';
                container.innerHTML = `<div class="max-w-md mx-auto fade-in"><div class="bg-slate-800 text-white p-6 rounded-3xl shadow-xl mb-6 relative overflow-hidden"><div class="relative z-10"><p class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Total Ventas</p><h2 class="text-4xl font-black tracking-tight">${ui.money(total)}</h2></div><i class="fas fa-chart-line absolute -right-4 -bottom-4 text-9xl text-white opacity-5"></i></div><h3 class="font-bold text-slate-700 mb-4 px-2 text-sm uppercase tracking-wide">Historial (${state.invoices.length})</h3><div>${list}</div></div>`;
            },
            renderEditor: (container) => {
                const options = PRODUCTS.map((p, i) => `<option value="${i}">${p.name}</option>`).join('');
                const logoPreview = state.logoUrl ? `<img src="${state.logoUrl}" class="h-10 object-contain cursor-pointer border border-slate-200 rounded p-1 bg-white" onclick="document.getElementById('logo-input').click()">` : `<div onclick="document.getElementById('logo-input').click()" class="h-10 w-10 bg-slate-100 rounded flex items-center justify-center text-slate-400 cursor-pointer border border-dashed border-slate-300"><i class="fas fa-plus"></i></div>`;
                
                // AQUÍ ESTÁ LA CORRECCIÓN PRINCIPAL (logic.updateClient)
                container.innerHTML = `<div class="max-w-md mx-auto fade-in pb-20"><div class="flex justify-between items-center mb-4 px-2"><h2 class="text-xl font-black text-slate-800">Nueva Venta</h2><div class="flex items-center gap-2"><span class="text-xs text-slate-400 font-bold">LOGO:</span><input type="file" id="logo-input" accept="image/*" class="hidden" onchange="logic.uploadLogo(this)">${logoPreview}</div></div><div class="bg-white p-5 rounded-2xl shadow-lg border border-slate-100 mb-4"><div class="mb-4"><label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Cliente</label><input type="text" id="client-input" value="${state.clientName}" oninput="logic.updateClient(this.value)" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" placeholder="Nombre del cliente"></div><div class="p-3 bg-indigo-50 rounded-xl border border-indigo-100"><div class="flex gap-2 mb-2"><select id="prod-select" class="flex-grow p-2 text-sm rounded-lg border-none focus:ring-0 bg-white shadow-sm font-medium text-slate-700"><option value="" disabled selected>Selecciona producto...</option>${options}</select></div><div class="flex gap-2"><input type="number" id="manual-price" placeholder="Precio ($)" class="w-24 p-2 text-sm rounded-lg border-none shadow-sm text-center font-bold text-slate-700"><button onclick="logic.addToCart()" class="flex-grow bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold text-sm shadow transition"><i class="fas fa-plus mr-1"></i> AGREGAR</button></div></div></div><div id="cart-list" class="space-y-2 mb-6 min-h-[50px]"><p class="text-center text-slate-400 text-sm italic py-4">Agrega productos...</p></div><div class="bg-slate-900 text-white p-5 rounded-2xl shadow-xl flex justify-between items-center mb-6 sticky bottom-4"><div><p class="text-xs text-slate-400 font-bold uppercase">Total</p><p class="text-2xl font-black" id="cart-total">$ 0</p></div><button onclick="logic.openPreview(true)" class="bg-white text-slate-900 px-6 py-3 rounded-xl font-bold text-sm hover:bg-slate-200 transition shadow-lg active:scale-95">GENERAR <i class="fas fa-arrow-right ml-1"></i></button></div></div>`;
                
                document.getElementById('prod-select').addEventListener('change', (e) => { document.getElementById('manual-price').value = PRODUCTS[e.target.value].price; });
                ui.renderCart();
            },
            renderCart: () => {
                const container = document.getElementById('cart-list');
                if (!container) return;
                if (state.cart.length === 0) { container.innerHTML = '<p class="text-center text-slate-400 text-sm italic py-4">Agrega productos...</p>'; document.getElementById('cart-total').innerText = "$ 0"; return; }
                let total = 0;
                container.innerHTML = state.cart.map((item, idx) => {
                    total += (item.price * item.qty);
                    return `<div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex justify-between items-center"><div><span class="font-bold text-slate-700 text-sm block">${item.name}</span><span class="text-xs text-slate-400">${item.qty} x ${ui.money(item.price)}</span></div><div class="flex items-center gap-3"><span class="font-bold text-slate-800 text-sm">${ui.money(item.price * item.qty)}</span><button onclick="logic.removeFromCart(${idx})" class="text-red-400 hover:text-red-600 bg-red-50 w-6 h-6 rounded flex items-center justify-center"><i class="fas fa-minus text-xs"></i></button></div></div>`;
                }).join('');
                document.getElementById('cart-total').innerText = ui.money(total);
            },
            generateInvoiceHtml: (data, number) => {
                const total = data.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
                let dateObj = new Date();
                if (data.date && data.date.seconds) dateObj = new Date(data.date.seconds * 1000);
                const dateStr = dateObj.toLocaleDateString('es-CO', { year: 'numeric', month: 'short', day: 'numeric' });
                const timeStr = dateObj.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' });
                const itemsHtml = data.cart.map(item => `<div class="flex justify-between items-start mb-2 text-sm border-b border-dashed border-slate-200 pb-1"><div class="w-3/4 pr-2"><span class="text-slate-800 font-bold block text-sm">${item.name}</span>${item.qty > 1 ? `<span class="text-[10px] bg-slate-100 text-slate-500 px-1 rounded font-bold">x${item.qty}</span>` : ''}</div><span class="text-slate-900 font-bold">${ui.money(item.price * item.qty)}</span></div>`).join('');
                const defaultLogo = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0MDAgMTUwIj48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtd2VpZ2h0PSI5MDAiIGZvbnQtc2l6ZT0iNjAiIGZpbGw9IiM0MzNjOGIiPkQmYW1wO1IgREVTSUdOUzwvdGV4dD48L3N2Zz4=";
                const logo = `<img src="${state.logoUrl || defaultLogo}" class="h-24 mx-auto object-contain mb-2">`;
                const numDisplay = number ? String(number).padStart(3, '0') : 'BORRADOR';

                return `
                    <div class="invoice-card p-8 w-full text-slate-800 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-3 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
                        <div class="text-center mb-6 mt-4">${logo}<p class="text-[10px] font-bold text-indigo-600 uppercase tracking-[0.2em] mt-1">"${COMPANY.slogan}"</p></div>
                        <div class="flex justify-center mb-6"><div class="bg-slate-900 text-white px-4 py-1 rounded-full text-xs font-bold shadow-md">FACTURA N° ${numDisplay}</div></div>
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 mb-6 flex justify-between items-center"><div><p class="text-[10px] text-slate-400 font-bold uppercase">Cliente</p><p class="text-sm font-bold text-slate-900 capitalize">${data.clientName || 'Consumidor'}</p></div><div class="text-right"><p class="text-[10px] text-slate-400 font-bold uppercase">Fecha</p><p class="text-xs font-bold text-slate-700">${dateStr}</p><p class="text-[10px] text-slate-400">${timeStr}</p></div></div>
                        <div class="mb-6 min-h-[100px]">${itemsHtml}</div>
                        <div class="flex justify-between items-center mb-6 pt-3 border-t-2 border-slate-900"><span class="font-bold text-lg text-slate-600 uppercase">Total</span><span class="font-black text-3xl text-slate-900">${ui.money(total)}</span></div>
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-r-lg shadow-sm"><p class="text-[10px] font-bold text-yellow-600 uppercase mb-1 tracking-wider flex items-center gap-1"><i class="fas fa-university"></i> Medio de Pago</p><p class="text-xs font-bold text-slate-700">${COMPANY.bank}</p><p class="text-lg font-black text-slate-900 tracking-wide">${COMPANY.account}</p></div>
                        <div class="text-center border-t border-slate-100 pt-4"><p class="text-[10px] text-slate-400 mb-1">Gracias por apoyar nuestro emprendimiento</p><p class="text-[9px] text-slate-300 font-mono">Generado por D&R System</p></div>
                    </div>`;
            },
            closeModal: () => document.getElementById('preview-modal').classList.add('hidden')
        };

        const logic = {
            updateClient: (val) => {
                state.clientName = val;
            },
            uploadLogo: (input) => {
                if (input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => { state.logoUrl = e.target.result; localStorage.setItem('dr_logo_v5', e.target.result); ui.navigate('editor'); };
                    reader.readAsDataURL(input.files[0]);
                }
            },
            addToCart: () => {
                const select = document.getElementById('prod-select');
                const priceInput = document.getElementById('manual-price');
                if (select.value === "" || priceInput.value === "") return alert("Selecciona producto");
                const product = PRODUCTS[select.value];
                const price = parseFloat(priceInput.value);
                const existing = state.cart.find(p => p.name === product.name && p.price === price);
                if (existing) existing.qty++; else state.cart.push({ name: product.name, price: price, qty: 1 });
                ui.renderCart(); select.value = ""; priceInput.value = "";
            },
            removeFromCart: (idx) => { state.cart.splice(idx, 1); ui.renderCart(); },
            getNextNumber: async () => {
                if (!state.user || !db) return 1;
                try {
                    const ref = collection(db, 'artifacts', appId, 'users', state.user.uid, 'invoices');
                    const q = query(ref, orderBy('number', 'desc'), limit(1));
                    const snap = await getDocs(q);
                    return !snap.empty ? (snap.docs[0].data().number || 0) + 1 : 1;
                } catch (e) { return 1; }
            },
            openPreview: async (isNew = true) => {
                if (isNew) {
                    if (!state.clientName) return alert("Falta Cliente");
                    if (state.cart.length === 0) return alert("Faltan Productos");
                    state.viewingInvoice = null;
                    state.nextInvoiceNumber = 'PENDIENTE';
                }
                document.getElementById('preview-modal').classList.remove('hidden');
                const data = state.viewingInvoice || { clientName: state.clientName, cart: state.cart, date: new Date() };
                const number = state.viewingInvoice ? state.viewingInvoice.number : state.nextInvoiceNumber;
                const html = ui.generateInvoiceHtml(data, number);
                document.getElementById('screen-preview-container').innerHTML = html;
                document.getElementById('offscreen-render-area').innerHTML = html;
                const btnSave = document.getElementById('btn-save');
                if (state.viewingInvoice) btnSave.classList.add('hidden'); else btnSave.classList.remove('hidden');
                if(isNew && state.user && db) {
                    try {
                        const next = await logic.getNextNumber();
                        state.nextInvoiceNumber = next;
                         if (!document.getElementById('preview-modal').classList.contains('hidden')) {
                             const updatedHtml = ui.generateInvoiceHtml(data, next);
                             document.getElementById('screen-preview-container').innerHTML = updatedHtml;
                             document.getElementById('offscreen-render-area').innerHTML = updatedHtml;
                         }
                    } catch(e) {}
                }
            },
            viewInvoice: (id) => { const inv = state.invoices.find(i => i.id === id); if (inv) { state.viewingInvoice = inv; logic.openPreview(false); } },
            downloadImage: () => {
                const element = document.querySelector('#offscreen-render-area .invoice-card');
                const btn = document.getElementById('btn-download');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                const data = state.viewingInvoice || { clientName: state.clientName, number: state.nextInvoiceNumber };
                html2canvas(element, { scale: 2, useCORS: true, backgroundColor: '#ffffff' }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `Factura_${data.number}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.95);
                    link.click();
                    btn.innerHTML = originalText;
                });
            },
            saveAndClose: async () => {
                if (!state.user) return alert("No hay sesión.");
                const numToSave = (typeof state.nextInvoiceNumber === 'number') ? state.nextInvoiceNumber : 1;
                try {
                    const total = state.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
                    await addDoc(collection(db, 'artifacts', appId, 'users', state.user.uid, 'invoices'), {
                        client: state.clientName, items: state.cart, total: total, number: numToSave, date: serverTimestamp(), status: 'pending'
                    });
                    state.cart = []; state.clientName = ""; ui.closeModal(); ui.navigate('dashboard');
                } catch(e) { alert("Error al guardar."); }
            },
            deleteInvoice: async (id) => { if(confirm("¿Borrar?")) await deleteDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'invoices', id)); }
        };

        // Renombramos la variable global para evitar conflictos
        const appActions = { 
            login: async () => { 
                const btn = document.getElementById('login-btn');
                btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> CONECTANDO...';
                try { await signInAnonymously(auth); } 
                catch(e) { 
                    alert("Error al conectar: " + e.message); 
                    btn.innerHTML = "INGRESAR";
                } 
            }, 
            logout: () => signOut(auth) 
        };

        if (auth) {
            onAuthStateChanged(auth, (user) => {
                state.user = user;
                if (user) {
                    document.getElementById('nav-actions').classList.remove('hidden');
                    const ref = collection(db, 'artifacts', appId, 'users', user.uid, 'invoices');
                    onSnapshot(ref, (snap) => {
                        const data = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        state.invoices = data.sort((a, b) => (b.date?.seconds || 0) - (a.date?.seconds || 0));
                        if (!document.getElementById('client-input')) ui.renderDashboard(document.getElementById('main-content'));
                    });
                    ui.navigate('dashboard');
                } else ui.renderLogin(document.getElementById('main-content'));
            });
        } else { ui.renderLogin(document.getElementById('main-content')); }

        // Exponer variables seguras
        window.appActions = appActions; 
        window.app = appActions; 
        window.logic = logic; 
        window.ui = ui;
    </script>
</body>
</html>
